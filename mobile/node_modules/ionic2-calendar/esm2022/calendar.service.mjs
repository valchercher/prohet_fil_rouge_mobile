import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
class CalendarService {
    constructor() {
        this._currentDate = new Date();
        this.currentDateChangedFromParent = new Subject();
        this.currentDateChangedFromChildren = new Subject();
        this.eventSourceChanged = new Subject();
        this.slideChanged = new Subject();
        this.slideUpdated = new Subject();
        this.currentDateChangedFromParent$ = this.currentDateChangedFromParent.asObservable();
        this.currentDateChangedFromChildren$ = this.currentDateChangedFromChildren.asObservable();
        this.eventSourceChanged$ = this.eventSourceChanged.asObservable();
        this.slideChanged$ = this.slideChanged.asObservable();
        this.slideUpdated$ = this.slideUpdated.asObservable();
    }
    setCurrentDate(val, fromParent = false) {
        this._currentDate = new Date(val);
        if (fromParent) {
            this.currentDateChangedFromParent.next(val);
        }
        else {
            this.currentDateChangedFromChildren.next(val);
        }
    }
    get currentDate() {
        return this._currentDate;
    }
    rangeChanged(component) {
        if (this.queryMode === 'local') {
            if (component.eventSource && component.onDataLoaded) {
                component.onDataLoaded();
            }
        }
        else if (this.queryMode === 'remote') {
            let rangeStart = new Date(component.range.startTime.getTime()), rangeEnd = new Date(component.range.endTime.getTime());
            rangeStart.setHours(0);
            if (rangeStart.getHours() === 23) {
                rangeStart.setTime(rangeStart.getTime() + 3600000);
            }
            rangeEnd.setHours(0);
            if (rangeEnd.getHours() === 23) {
                rangeEnd.setTime(rangeEnd.getTime() + 3600000);
            }
            component.onRangeChanged.emit({
                startTime: rangeStart,
                endTime: rangeEnd
            });
        }
    }
    getStep(mode) {
        switch (mode) {
            case 'month':
                return {
                    years: 0,
                    months: 1,
                    days: 0
                };
            case 'week':
                return {
                    years: 0,
                    months: 0,
                    days: 7
                };
            case 'day':
                return {
                    years: 0,
                    months: 0,
                    days: 1
                };
        }
    }
    getAdjacentCalendarDate(mode, direction) {
        let calculateCalendarDate = this.currentDate;
        const step = this.getStep(mode), year = calculateCalendarDate.getFullYear() + direction * step.years, month = calculateCalendarDate.getMonth() + direction * step.months, date = calculateCalendarDate.getDate() + direction * step.days;
        calculateCalendarDate = new Date(year, month, date, 12, 0, 0);
        if (mode === 'month') {
            const firstDayInNextMonth = new Date(year, month + 1, 1, 12, 0, 0);
            if (firstDayInNextMonth.getTime() <= calculateCalendarDate.getTime()) {
                calculateCalendarDate = new Date(firstDayInNextMonth.getTime() - 24 * 60 * 60 * 1000);
            }
        }
        return calculateCalendarDate;
    }
    getAdjacentViewStartTime(component, direction) {
        let adjacentCalendarDate = this.getAdjacentCalendarDate(component.mode, direction);
        return component.getRange(adjacentCalendarDate).startTime;
    }
    populateAdjacentViews(component) {
        let currentViewStartDate, currentViewData, toUpdateViewIndex, currentViewIndex = component.currentViewIndex;
        if (component.direction === 1) {
            currentViewStartDate = this.getAdjacentViewStartTime(component, 1);
            toUpdateViewIndex = (currentViewIndex + 1) % 3;
            component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
        }
        else if (component.direction === -1) {
            currentViewStartDate = this.getAdjacentViewStartTime(component, -1);
            toUpdateViewIndex = (currentViewIndex + 2) % 3;
            component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
        }
        else {
            if (!component.views) {
                currentViewData = [];
                currentViewStartDate = component.range.startTime;
                currentViewData.push(component.getViewData(currentViewStartDate));
                currentViewStartDate = this.getAdjacentViewStartTime(component, 1);
                currentViewData.push(component.getViewData(currentViewStartDate));
                currentViewStartDate = this.getAdjacentViewStartTime(component, -1);
                currentViewData.push(component.getViewData(currentViewStartDate));
                component.views = currentViewData;
            }
            else {
                currentViewStartDate = component.range.startTime;
                component.views[currentViewIndex] = component.getViewData(currentViewStartDate);
                currentViewStartDate = this.getAdjacentViewStartTime(component, -1);
                toUpdateViewIndex = (currentViewIndex + 2) % 3;
                component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
                currentViewStartDate = this.getAdjacentViewStartTime(component, 1);
                toUpdateViewIndex = (currentViewIndex + 1) % 3;
                component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
            }
        }
    }
    loadEvents() {
        this.eventSourceChanged.next();
    }
    slide(direction) {
        this.slideChanged.next(direction);
    }
    update() {
        this.slideUpdated.next();
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.1.1", ngImport: i0, type: CalendarService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.1.1", ngImport: i0, type: CalendarService }); }
}
export { CalendarService };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.1.1", ngImport: i0, type: CalendarService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsZW5kYXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jYWxlbmRhci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFhLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQzs7QUFJekMsTUFDYSxlQUFlO0lBZXhCO1FBUFEsaUJBQVksR0FBUyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ2hDLGlDQUE0QixHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDbkQsbUNBQThCLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUNyRCx1QkFBa0IsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBQ3pDLGlCQUFZLEdBQUcsSUFBSSxPQUFPLEVBQVUsQ0FBQztRQUNyQyxpQkFBWSxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFHdkMsSUFBSSxDQUFDLDZCQUE2QixHQUFHLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUN0RixJQUFJLENBQUMsK0JBQStCLEdBQUcsSUFBSSxDQUFDLDhCQUE4QixDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzFGLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDbEUsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUMxRCxDQUFDO0lBRUQsY0FBYyxDQUFDLEdBQVMsRUFBRSxhQUFzQixLQUFLO1FBQ2pELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEMsSUFBSSxVQUFVLEVBQUU7WUFDWixJ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U0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BFLGlCQUFpQixHQUFHLENBQUMsZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUMvQyxTQUFTLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2dCQUNqRixvQkFBb0IsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNuRSxpQkFBaUIsR0FBRyxDQUFDLGdCQUFnQixHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDL0MsU0FBUyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUMsQ0FBQzthQUNwRjtTQUNKO0lBQ0wsQ0FBQztJQUVELFVBQVU7UUFDTixJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbkMsQ0FBQztJQUVELEtBQUssQ0FBQyxTQUFpQjtRQUNuQixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQsTUFBTTtRQUNGLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDN0IsQ0FBQzs4R0ExSlEsZUFBZTtrSEFBZixlQUFlOztTQUFmLGVBQWU7MkZBQWYsZUFBZTtrQkFEM0IsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge09ic2VydmFibGUsIFN1YmplY3R9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge0lDYWxlbmRhckNvbXBvbmVudCwgSVZpZXcsIENhbGVuZGFyTW9kZSwgUXVlcnlNb2RlfSBmcm9tICcuL2NhbGVuZGFyLmludGVyZmFjZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDYWxlbmRhclNlcnZpY2Uge1xuICAgIHF1ZXJ5TW9kZSE6IFF1ZXJ5TW9kZTtcbiAgICBjdXJyZW50RGF0ZUNoYW5nZWRGcm9tUGFyZW50JDogT2JzZXJ2YWJsZTxEYXRlPjtcbiAgICBjdXJyZW50RGF0ZUNoYW5nZWRGcm9tQ2hpbGRyZW4kOiBPYnNlcnZhYmxlPERhdGU+O1xuICAgIGV2ZW50U291cmNlQ2hhbmdlZCQ6IE9ic2VydmFibGU8dm9pZD47XG4gICAgc2xpZGVDaGFuZ2VkJDogT2JzZXJ2YWJsZTxudW1iZXI+O1xuICAgIHNsaWRlVXBkYXRlZCQ6IE9ic2VydmFibGU8dm9pZD47XG5cbiAgICBwcml2YXRlIF9jdXJyZW50RGF0ZTogRGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgcHJpdmF0ZSBjdXJyZW50RGF0ZUNoYW5nZWRGcm9tUGFyZW50ID0gbmV3IFN1YmplY3Q8RGF0ZT4oKTtcbiAgICBwcml2YXRlIGN1cnJlbnREYXRlQ2hhbmdlZEZyb21DaGlsZHJlbiA9IG5ldyBTdWJqZWN0PERhdGU+KCk7XG4gICAgcHJpdmF0ZSBldmVudFNvdXJjZUNoYW5nZWQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuICAgIHByaXZhdGUgc2xpZGVDaGFuZ2VkID0gbmV3IFN1YmplY3Q8bnVtYmVyPigpO1xuICAgIHByaXZhdGUgc2xpZGVVcGRhdGVkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLmN1cnJlbnREYXRlQ2hhbmdlZEZyb21QYXJlbnQkID0gdGhpcy5jdXJyZW50RGF0ZUNoYW5nZWRGcm9tUGFyZW50LmFzT2JzZXJ2YWJsZSgpO1xuICAgICAgICB0aGlzLmN1cnJlbnREYXRlQ2hhbmdlZEZyb21DaGlsZHJlbiQgPSB0aGlzLmN1cnJlbnREYXRlQ2hhbmdlZEZyb21DaGlsZHJlbi5hc09ic2VydmFibGUoKTtcbiAgICAgICAgdGhpcy5ldmVudFNvdXJjZUNoYW5nZWQkID0gdGhpcy5ldmVudFNvdXJjZUNoYW5nZWQuYXNPYnNlcnZhYmxlKCk7XG4gICAgICAgIHRoaXMuc2xpZGVDaGFuZ2VkJCA9IHRoaXMuc2xpZGVDaGFuZ2VkLmFzT2JzZXJ2YWJsZSgpO1xuICAgICAgICB0aGlzLnNsaWRlVXBkYXRlZCQgPSB0aGlzLnNsaWRlVXBkYXRlZC5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICBzZXRDdXJyZW50RGF0ZSh2YWw6IERhdGUsIGZyb21QYXJlbnQ6IGJvb2xlYW4gPSBmYWxzZSkge1xuICAgICAgICB0aGlzLl9jdXJyZW50RGF0ZSA9IG5ldyBEYXRlKHZhbCk7XG4gICAgICAgIGlmIChmcm9tUGFyZW50KSB7XG4gICAgICAgICAgICB0aGlzLmN1cnJlbnREYXRlQ2hhbmdlZEZyb21QYXJlbnQubmV4dCh2YWwpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50RGF0ZUNoYW5nZWRGcm9tQ2hpbGRyZW4ubmV4dCh2YWwpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0IGN1cnJlbnREYXRlKCk6IERhdGUge1xuICAgICAgICByZXR1cm4gdGhpcy5fY3VycmVudERhdGU7XG4gICAgfVxuXG4gICAgcmFuZ2VDaGFuZ2VkKGNvbXBvbmVudDogSUNhbGVuZGFyQ29tcG9uZW50KSB7XG4gICAgICAgIGlmICh0aGlzLnF1ZXJ5TW9kZSA9PT0gJ2xvY2FsJykge1xuICAgICAgICAgICAgaWYgKGNvbXBvbmVudC5ldmVudFNvdXJjZSAmJiBjb21wb25lbnQub25EYXRhTG9hZGVkKSB7XG4gICAgICAgICAgICAgICAgY29tcG9uZW50Lm9uRGF0YUxvYWRlZCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMucXVlcnlNb2RlID09PSAncmVtb3RlJykge1xuICAgICAgICAgICAgbGV0IHJhbmdlU3RhcnQgPSBuZXcgRGF0ZShjb21wb25lbnQucmFuZ2Uuc3RhcnRUaW1lLmdldFRpbWUoKSksXG4gICAgICAgICAgICAgICAgcmFuZ2VFbmQgPSBuZXcgRGF0ZShjb21wb25lbnQucmFuZ2UuZW5kVGltZS5nZXRUaW1lKCkpO1xuXG4gICAgICAgICAgICByYW5nZVN0YXJ0LnNldEhvdXJzKDApO1xuICAgICAgICAgICAgaWYgKHJhbmdlU3RhcnQuZ2V0SG91cnMoKSA9PT0gMjMpIHtcbiAgICAgICAgICAgICAgICByYW5nZVN0YXJ0LnNldFRpbWUocmFuZ2VTdGFydC5nZXRUaW1lKCkgKyAzNjAwMDAwKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmFuZ2VFbmQuc2V0SG91cnMoMCk7XG4gICAgICAgICAgICBpZiAocmFuZ2VFbmQuZ2V0SG91cnMoKSA9PT0gMjMpIHtcbiAgICAgICAgICAgICAgICByYW5nZUVuZC5zZXRUaW1lKHJhbmdlRW5kLmdldFRpbWUoKSArIDM2MDAwMDApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29tcG9uZW50Lm9uUmFuZ2VDaGFuZ2VkLmVtaXQoe1xuICAgICAgICAgICAgICAgIHN0YXJ0VGltZTogcmFuZ2VTdGFydCxcbiAgICAgICAgICAgICAgICBlbmRUaW1lOiByYW5nZUVuZFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFN0ZXAobW9kZTogQ2FsZW5kYXJNb2RlKTogeyB5ZWFyczogbnVtYmVyOyBtb250aHM6IG51bWJlcjsgZGF5czogbnVtYmVyOyB9IHtcbiAgICAgICAgc3dpdGNoIChtb2RlKSB7XG4gICAgICAgICAgICBjYXNlICdtb250aCc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgeWVhcnM6IDAsXG4gICAgICAgICAgICAgICAgICAgIG1vbnRoczogMSxcbiAgICAgICAgICAgICAgICAgICAgZGF5czogMFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjYXNlICd3ZWVrJzpcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICB5ZWFyczogMCxcbiAgICAgICAgICAgICAgICAgICAgbW9udGhzOiAwLFxuICAgICAgICAgICAgICAgICAgICBkYXlzOiA3XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNhc2UgJ2RheSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgeWVhcnM6IDAsXG4gICAgICAgICAgICAgICAgICAgIG1vbnRoczogMCxcbiAgICAgICAgICAgICAgICAgICAgZGF5czogMVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRBZGphY2VudENhbGVuZGFyRGF0ZShtb2RlOiBDYWxlbmRhck1vZGUsIGRpcmVjdGlvbjogbnVtYmVyKTogRGF0ZSB7XG4gICAgICAgIGxldCBjYWxjdWxhdGVDYWxlbmRhckRhdGUgPSB0aGlzLmN1cnJlbnREYXRlO1xuICAgICAgICBjb25zdCBzdGVwID0gdGhpcy5nZXRTdGVwKG1vZGUpLFxuICAgICAgICAgICAgeWVhciA9IGNhbGN1bGF0ZUNhbGVuZGFyRGF0ZS5nZXRGdWxsWWVhcigpICsgZGlyZWN0aW9uICogc3RlcC55ZWFycyxcbiAgICAgICAgICAgIG1vbnRoID0gY2FsY3VsYXRlQ2FsZW5kYXJEYXRlLmdldE1vbnRoKCkgKyBkaXJlY3Rpb24gKiBzdGVwLm1vbnRocyxcbiAgICAgICAgICAgIGRhdGUgPSBjYWxjdWxhdGVDYWxlbmRhckRhdGUuZ2V0RGF0ZSgpICsgZGlyZWN0aW9uICogc3RlcC5kYXlzO1xuXG4gICAgICAgIGNhbGN1bGF0ZUNhbGVuZGFyRGF0ZSA9IG5ldyBEYXRlKHllYXIsIG1vbnRoLCBkYXRlLCAxMiwgMCwgMCk7XG5cbiAgICAgICAgaWYgKG1vZGUgPT09ICdtb250aCcpIHtcbiAgICAgICAgICAgIGNvbnN0IGZpcnN0RGF5SW5OZXh0TW9udGggPSBuZXcgRGF0ZSh5ZWFyLCBtb250aCArIDEsIDEsIDEyLCAwLCAwKTtcbiAgICAgICAgICAgIGlmIChmaXJzdERheUluTmV4dE1vbnRoLmdldFRpbWUoKSA8PSBjYWxjdWxhdGVDYWxlbmRhckRhdGUuZ2V0VGltZSgpKSB7XG4gICAgICAgICAgICAgICAgY2FsY3VsYXRlQ2FsZW5kYXJEYXRlID0gbmV3IERhdGUoZmlyc3REYXlJbk5leHRNb250aC5nZXRUaW1lKCkgLSAyNCAqIDYwICogNjAgKiAxMDAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY2FsY3VsYXRlQ2FsZW5kYXJEYXRlO1xuICAgIH1cblxuICAgIGdldEFkamFjZW50Vmlld1N0YXJ0VGltZShjb21wb25lbnQ6IElDYWxlbmRhckNvbXBvbmVudCwgZGlyZWN0aW9uOiBudW1iZXIpOiBEYXRlIHtcbiAgICAgICAgbGV0IGFkamFjZW50Q2FsZW5kYXJEYXRlID0gdGhpcy5nZXRBZGphY2VudENhbGVuZGFyRGF0ZShjb21wb25lbnQubW9kZSwgZGlyZWN0aW9uKTtcbiAgICAgICAgcmV0dXJuIGNvbXBvbmVudC5nZXRSYW5nZShhZGphY2VudENhbGVuZGFyRGF0ZSkuc3RhcnRUaW1lO1xuICAgIH1cblxuICAgIHBvcHVsYXRlQWRqYWNlbnRWaWV3cyhjb21wb25lbnQ6IElDYWxlbmRhckNvbXBvbmVudCkge1xuICAgICAgICBsZXQgY3VycmVudFZpZXdTdGFydERhdGU6IERhdGUsXG4gICAgICAgICAgICBjdXJyZW50Vmlld0RhdGE6IElWaWV3W10sXG4gICAgICAgICAgICB0b1VwZGF0ZVZpZXdJbmRleDogbnVtYmVyLFxuICAgICAgICAgICAgY3VycmVudFZpZXdJbmRleCA9IGNvbXBvbmVudC5jdXJyZW50Vmlld0luZGV4O1xuXG4gICAgICAgIGlmIChjb21wb25lbnQuZGlyZWN0aW9uID09PSAxKSB7XG4gICAgICAgICAgICBjdXJyZW50Vmlld1N0YXJ0RGF0ZSA9IHRoaXMuZ2V0QWRqYWNlbnRWaWV3U3RhcnRUaW1lKGNvbXBvbmVudCwgMSk7XG4gICAgICAgICAgICB0b1VwZGF0ZVZpZXdJbmRleCA9IChjdXJyZW50Vmlld0luZGV4ICsgMSkgJSAzO1xuICAgICAgICAgICAgY29tcG9uZW50LnZpZXdzW3RvVXBkYXRlVmlld0luZGV4XSA9IGNvbXBvbmVudC5nZXRWaWV3RGF0YShjdXJyZW50Vmlld1N0YXJ0RGF0ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoY29tcG9uZW50LmRpcmVjdGlvbiA9PT0gLTEpIHtcbiAgICAgICAgICAgIGN1cnJlbnRWaWV3U3RhcnREYXRlID0gdGhpcy5nZXRBZGphY2VudFZpZXdTdGFydFRpbWUoY29tcG9uZW50LCAtMSk7XG4gICAgICAgICAgICB0b1VwZGF0ZVZpZXdJbmRleCA9IChjdXJyZW50Vmlld0luZGV4ICsgMikgJSAzO1xuICAgICAgICAgICAgY29tcG9uZW50LnZpZXdzW3RvVXBkYXRlVmlld0luZGV4XSA9IGNvbXBvbmVudC5nZXRWaWV3RGF0YShjdXJyZW50Vmlld1N0YXJ0RGF0ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoIWNvbXBvbmVudC52aWV3cykge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3RGF0YSA9IFtdO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3U3RhcnREYXRlID0gY29tcG9uZW50LnJhbmdlLnN0YXJ0VGltZTtcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld0RhdGEucHVzaChjb21wb25lbnQuZ2V0Vmlld0RhdGEoY3VycmVudFZpZXdTdGFydERhdGUpKTtcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld1N0YXJ0RGF0ZSA9IHRoaXMuZ2V0QWRqYWNlbnRWaWV3U3RhcnRUaW1lKGNvbXBvbmVudCwgMSk7XG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdEYXRhLnB1c2goY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKSk7XG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdTdGFydERhdGUgPSB0aGlzLmdldEFkamFjZW50Vmlld1N0YXJ0VGltZShjb21wb25lbnQsIC0xKTtcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld0RhdGEucHVzaChjb21wb25lbnQuZ2V0Vmlld0RhdGEoY3VycmVudFZpZXdTdGFydERhdGUpKTtcbiAgICAgICAgICAgICAgICBjb21wb25lbnQudmlld3MgPSBjdXJyZW50Vmlld0RhdGE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3U3RhcnREYXRlID0gY29tcG9uZW50LnJhbmdlLnN0YXJ0VGltZTtcbiAgICAgICAgICAgICAgICBjb21wb25lbnQudmlld3NbY3VycmVudFZpZXdJbmRleF0gPSBjb21wb25lbnQuZ2V0Vmlld0RhdGEoY3VycmVudFZpZXdTdGFydERhdGUpO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3U3RhcnREYXRlID0gdGhpcy5nZXRBZGphY2VudFZpZXdTdGFydFRpbWUoY29tcG9uZW50LCAtMSk7XG4gICAgICAgICAgICAgICAgdG9VcGRhdGVWaWV3SW5kZXggPSAoY3VycmVudFZpZXdJbmRleCArIDIpICUgMztcbiAgICAgICAgICAgICAgICBjb21wb25lbnQudmlld3NbdG9VcGRhdGVWaWV3SW5kZXhdID0gY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKTtcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld1N0YXJ0RGF0ZSA9IHRoaXMuZ2V0QWRqYWNlbnRWaWV3U3RhcnRUaW1lKGNvbXBvbmVudCwgMSk7XG4gICAgICAgICAgICAgICAgdG9VcGRhdGVWaWV3SW5kZXggPSAoY3VycmVudFZpZXdJbmRleCArIDEpICUgMztcbiAgICAgICAgICAgICAgICBjb21wb25lbnQudmlld3NbdG9VcGRhdGVWaWV3SW5kZXhdID0gY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGxvYWRFdmVudHMoKSB7XG4gICAgICAgIHRoaXMuZXZlbnRTb3VyY2VDaGFuZ2VkLm5leHQoKTtcbiAgICB9XG5cbiAgICBzbGlkZShkaXJlY3Rpb246IG51bWJlcikge1xuICAgICAgICB0aGlzLnNsaWRlQ2hhbmdlZC5uZXh0KGRpcmVjdGlvbik7XG4gICAgfVxuXG4gICAgdXBkYXRlKCkge1xuICAgICAgICB0aGlzLnNsaWRlVXBkYXRlZC5uZXh0KCk7XG4gICAgfVxufVxuIl19